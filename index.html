<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Direct Contract Interaction — Injected Only</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:'Inter',sans-serif;background:#0d0c22}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .status-dot-pulse{animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite}
    .card-bg{background:rgba(23,22,49,.75);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);transition:border-color .3s ease,box-shadow .3s ease}
    .card-bg:hover{border-color:rgba(233,30,99,.8);box-shadow:0 0 20px rgba(233,30,99,.2)}
  </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center min-h-screen p-4 md:p-8">
  <div class="w-full max-w-2xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white tracking-wider">Direct Contract Interaction</h1>
      <p class="text-pink-400 mt-2 text-lg">Ethers v6 · Injected Wallets (MetaMask/Rabby/Coinbase ext)</p>
    </header>

    <div class="space-y-6">
      <!-- Step 1: Connect Wallet -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-white">Step 1: Connect Your Wallet</h2>
          <div id="connection-status" class="flex items-center space-x-2">
            <div id="status-dot" class="w-3 h-3 bg-red-500 rounded-full"></div>
            <span id="status-text" class="text-gray-400">Not Connected</span>
          </div>
        </div>
        <div class="mt-3 space-y-2">
          <div id="walletSelectWrap" class="hidden">
            <label class="block text-xs text-gray-400 mb-1">Detected wallets (EIP‑6963)</label>
            <select id="walletSelect" class="w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500"></select>
          </div>
          <button id="connectButton" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg shadow-pink-500/20">Connect Injected Wallet</button>
        </div>
        <div id="wallet-info" class="mt-4 text-sm text-gray-400 hidden">
          <p>Address: <span id="wallet-address" class="font-mono text-cyan-400"></span></p>
          <p>Network: <span id="network-name" class="font-mono text-cyan-400"></span></p>
          <button id="disconnectButton" class="mt-2 text-sm text-red-400 hover:text-red-300 underline">Disconnect</button>
        </div>
        <p class="text-xs text-gray-500 mt-3">Tip: If multiple extensions are installed, pick one in the dropdown above.</p>
      </div>

      <!-- Step 2: Chain & Contract Details -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white">Step 2: Chain & Contract Details</h2>
        <div class="mt-4 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Target Chain</label>
            <select id="targetChain" class="w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500"></select>
            <p class="text-xs text-gray-500 mt-1">We'll switch your wallet automatically. If the chain isn't added, we'll prompt to add it.</p>
          </div>
          <div>
            <label for="contractAddress" class="block text-sm font-medium text-gray-300">Contract Address</label>
            <input id="contractAddress" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0x..." />
          </div>
          <div>
            <label for="contractAbi" class="block text-sm font-medium text-gray-300">Contract ABI (JSON)</label>
            <textarea id="contractAbi" rows="6" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder='[{"type":"function","name":"mint","stateMutability":"payable","inputs":[{"name":"qty","type":"uint256"}],"outputs":[]}]'></textarea>
          </div>
        </div>
      </div>

      <!-- Step 3: Build & Send Tx -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white">Step 3: Build & Send Transaction</h2>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-300 mb-2">Payment Method</label>
          <select id="paymentMethod" class="w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500">
            <option value="native">Native Coin (ETH, MATIC, etc.)</option>
            <option value="erc20">ERC20 Token (USDT, USDC, etc.)</option>
          </select>
        </div>

        <div id="nativePaymentFields" class="mt-4 space-y-4">
          <div>
            <label for="payableValue" class="block text-sm font-medium text-gray-300">Value to Send (ETH)</label>
            <input id="payableValue" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0.1" />
          </div>
        </div>

        <div id="erc20PaymentFields" class="hidden mt-4 space-y-4">
          <div>
            <label for="tokenAddress" class="block text-sm font-medium text-gray-300">Token Contract Address</label>
            <input id="tokenAddress" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0x... (USDT/USDC etc)" />
          </div>
          <div>
            <label for="tokenAmount" class="block text-sm font-medium text-gray-300">Token Amount (human units)</label>
            <input id="tokenAmount" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="e.g., 100" />
          </div>
          <div>
            <label for="customSpender" class="block text-sm font-medium text-gray-300">Custom Spender (optional)</label>
            <input id="customSpender" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="Router/processor if not the mint contract" />
          </div>
        </div>

        <div class="mt-4 space-y-4">
          <div>
            <label for="functionName" class="block text-sm font-medium text-gray-300">Function Name</label>
            <input id="functionName" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="mint, claim, buy" />
          </div>
          <div>
            <div class="flex items-center justify-between">
              <label for="functionArgs" class="block text-sm font-medium text-gray-300">Function Arguments (JSON array)</label>
              <span class="text-xs text-gray-400">Example: ["0xAbC...", 2, true, [1,2,3]]</span>
            </div>
            <input id="functionArgs" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="[] if none" />
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
          <div id="gasEstimateResult" class="text-sm text-gray-400">Fill details to estimate gas...</div>
          <button id="estimateGasButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-300 shadow-lg shadow-cyan-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Estimate Gas</button>
        </div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="sendTxButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg shadow-green-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Send Transaction</button>
          <button id="simulateButton" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg shadow-amber-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Simulate (static call)</button>
        </div>
      </div>

      <!-- Logs -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-white">Logs & Status</h2>
          <button id="clearLogs" class="text-xs text-gray-400 hover:text-gray-200 underline">Clear</button>
        </div>
        <div id="logArea" class="mt-4 bg-gray-900/50 rounded-md p-4 h-60 overflow-y-auto font-mono text-sm text-gray-400"><p>Awaiting connection...</p></div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-8 mb-4">
    <p class="text-sm text-gray-500">Created by <a href="https://x.com/0xKangLiu" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline">Alan</a></p>
  </footer>

  <script type="module">
    import { ethers } from 'https://esm.sh/ethers@6.11.1'

    // ==== DOM refs ====
    const connectButton = document.getElementById('connectButton')
    const disconnectButton = document.getElementById('disconnectButton')
    const sendTxButton = document.getElementById('sendTxButton')
    const estimateGasButton = document.getElementById('estimateGasButton')
    const simulateButton = document.getElementById('simulateButton')
    const statusDot = document.getElementById('status-dot')
    const statusText = document.getElementById('status-text')
    const walletInfoDiv = document.getElementById('wallet-info')
    const walletAddressSpan = document.getElementById('wallet-address')
    const networkNameSpan = document.getElementById('network-name')
    const logArea = document.getElementById('logArea')
    const gasEstimateResult = document.getElementById('gasEstimateResult')
    const clearLogsBtn = document.getElementById('clearLogs')

    const contractAddressInput = document.getElementById('contractAddress')
    const contractAbiInput = document.getElementById('contractAbi')
    const functionNameInput = document.getElementById('functionName')
    const functionArgsInput = document.getElementById('functionArgs')

    const paymentMethodSelect = document.getElementById('paymentMethod')
    const nativePaymentFields = document.getElementById('nativePaymentFields')
    const erc20PaymentFields = document.getElementById('erc20PaymentFields')
    const payableValueInput = document.getElementById('payableValue')
    const tokenAddressInput = document.getElementById('tokenAddress')
    const tokenAmountInput = document.getElementById('tokenAmount')
    const customSpenderInput = document.getElementById('customSpender')

    const targetChainSelect = document.getElementById('targetChain')
    const walletSelectWrap = document.getElementById('walletSelectWrap')
    const walletSelect = document.getElementById('walletSelect')

    // ==== State ====
    let provider // ethers.BrowserProvider
    let signer   // ethers.Signer
    let injectedProvider // chosen injected provider (EIP-6963 or window.ethereum)
    let userAddress
    let network

    // ==== Chains ====
    const CHAINS = [
      { chainId: 1, name: 'Ethereum', currency: 'ETH', explorerUrl: 'https://etherscan.io' },
      { chainId: 10, name: 'OP Mainnet', currency: 'ETH', explorerUrl: 'https://optimistic.etherscan.io' },
      { chainId: 8453, name: 'Base', currency: 'ETH', explorerUrl: 'https://basescan.org' },
      { chainId: 42161, name: 'Arbitrum One', currency: 'ETH', explorerUrl: 'https://arbiscan.io' },
      { chainId: 7777777, name: 'Zora', currency: 'ETH', explorerUrl: 'https://zorascan.xyz' },
      { chainId: 59144, name: 'Linea', currency: 'ETH', explorerUrl: 'https://lineascan.build' },
      { chainId: 324, name: 'zkSync Era', currency: 'ETH', explorerUrl: 'https://explorer.zksync.io' },
      { chainId: 56, name: 'BNB Chain', currency: 'BNB', explorerUrl: 'https://bscscan.com' },
      { chainId: 137, name: 'Polygon', currency: 'MATIC', explorerUrl: 'https://polygonscan.com' },
      { chainId: 43114, name: 'Avalanche', currency: 'AVAX', explorerUrl: 'https://snowtrace.io' },
      { chainId: 250, name: 'Fantom', currency: 'FTM', explorerUrl: 'https://ftmscan.com' },
      { chainId: 25, name: 'Cronos', currency: 'CRO', explorerUrl: 'https://cronoscan.com' },
      { chainId: 100, name: 'Gnosis', currency: 'xDAI', explorerUrl: 'https://gnosisscan.io' },
      { chainId: 1284, name: 'Moonbeam', currency: 'GLMR', explorerUrl: 'https://moonscan.io' },
      { chainId: 1285, name: 'Moonriver', currency: 'MOVR', explorerUrl: 'https://moonriver.moonscan.io' },
      // Testnets
      { chainId: 11155111, name: 'Sepolia', currency: 'ETH', explorerUrl: 'https://sepolia.etherscan.io' },
      { chainId: 84532, name: 'Base Sepolia', currency: 'ETH', explorerUrl: 'https://sepolia.basescan.org' },
      { chainId: 421614, name: 'Arbitrum Sepolia', currency: 'ETH', explorerUrl: 'https://sepolia.arbiscan.io' },
      { chainId: 11155420, name: 'OP Sepolia', currency: 'ETH', explorerUrl: 'https://sepolia-optimism.etherscan.io' }
    ]
    const CHAIN_MAP = new Map(CHAINS.map(c => [c.chainId, c]))

    // Minimal ERC20 ABI
    const ERC20_ABI = [
      'function approve(address spender, uint256 amount) returns (bool)',
      'function allowance(address owner, address spender) view returns (uint256)',
      'function decimals() view returns (uint8)'
    ]

    // ==== Utils: logs (safe) ====
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
    }
    function safeLog(message, type='info') {
      const now = new Date().toLocaleTimeString()
      const color = type==='error' ? 'text-red-400' : type==='success' ? 'text-green-400' : 'text-gray-400'
      const p = document.createElement('p')
      const ts = document.createElement('span'); ts.className='text-gray-500'; ts.textContent=`${now}: `
      const msg = document.createElement('span'); msg.className=color; msg.textContent = typeof message==='string'? message : JSON.stringify(message)
      p.appendChild(ts); p.appendChild(msg)
      logArea.appendChild(p)
      trimLogs(); logArea.scrollTop = logArea.scrollHeight
    }
    function logLink(label, href) {
      const p = document.createElement('p')
      const ts = document.createElement('span'); ts.className='text-gray-500'; ts.textContent=`${new Date().toLocaleTimeString()}: `
      const a = document.createElement('a'); a.className='text-pink-400 hover:underline'; a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=label
      p.appendChild(ts); p.appendChild(a); logArea.appendChild(p); trimLogs(); logArea.scrollTop = logArea.scrollHeight
    }
    function trimLogs() { while (logArea.childNodes.length > 500) logArea.removeChild(logArea.firstChild) }
    function explorer(net){ const c = CHAIN_MAP.get(Number(net.chainId)); return c ? c.explorerUrl : 'https://etherscan.io' }
    const ex = { tx: (b,h)=>`${b}/tx/${h}`, addr: (b,a)=>`${b}/address/${a}` }

    function updateConnectionStatus(isConnected, address='', networkLabel='') {
      statusDot.classList.toggle('bg-red-500', !isConnected)
      statusDot.classList.toggle('bg-green-500', isConnected)
      statusDot.classList.toggle('status-dot-pulse', isConnected)
      statusText.textContent = isConnected ? 'Connected' : 'Not Connected'
      walletInfoDiv.classList.toggle('hidden', !isConnected)
      connectButton.disabled = isConnected
      sendTxButton.disabled = !isConnected
      estimateGasButton.disabled = !isConnected
      simulateButton.disabled = !isConnected
      if (isConnected) {
        walletAddressSpan.textContent = `${address.slice(0,6)}...${address.slice(-4)}`
        networkNameSpan.textContent = networkLabel
      }
    }

    // ==== Wallet discovery (EIP-6963) ====
    const discovered = []
    window.addEventListener('eip6963:announceProvider', (event) => {
      const { info, provider } = event.detail
      discovered.push({ info, provider })
      walletSelectWrap.classList.remove('hidden')
      const opt = document.createElement('option')
      opt.value = String(discovered.length - 1)
      opt.textContent = `${info.name} (${info.uuid.slice(0,8)})`
      walletSelect.appendChild(opt)
    })
    window.dispatchEvent(new Event('eip6963:requestProvider'))

    // ==== Connect flow (Injected Only) ====
    async function connectInjected() {
      try {
        if (discovered.length && walletSelect.options.length) {
          const idx = Number(walletSelect.value || 0)
          injectedProvider = discovered[idx]?.provider
        }
        if (!injectedProvider) injectedProvider = window.ethereum
        if (!injectedProvider) throw new Error('No injected wallet detected (MetaMask/Rabby/Coinbase ext).')

        provider = new ethers.BrowserProvider(injectedProvider, 'any')
        await provider.send('eth_requestAccounts', [])
        signer = await provider.getSigner()
        const addr = await signer.getAddress()
        const net = await provider.getNetwork()
        userAddress = addr; network = net
        const c = CHAIN_MAP.get(Number(net.chainId))
        updateConnectionStatus(true, addr, c ? c.name : `Chain ${net.chainId}`)
        safeLog(`Injected wallet connected on ${c ? c.name : net.chainId}`, 'success')

        if (injectedProvider.on) {
          injectedProvider.on('accountsChanged', handleInjectedChanged)
          injectedProvider.on('chainChanged', handleInjectedChanged)
          injectedProvider.on('disconnect', () => disconnectWallet())
        }
      } catch (e) {
        safeLog(e.message || String(e), 'error')
        throw e
      }
    }

    async function handleInjectedChanged() {
      try {
        signer = await provider.getSigner()
        userAddress = await signer.getAddress()
        network = await provider.getNetwork()
        const c = CHAIN_MAP.get(Number(network.chainId))
        updateConnectionStatus(true, userAddress, c ? c.name : `Chain ${network.chainId}`)
      } catch (e) { safeLog(e.message || String(e), 'error') }
    }

    function disconnectWallet() {
      provider = null; signer = null; userAddress = null; network = null
      updateConnectionStatus(false)
      safeLog('Wallet disconnected.')
    }

    // ==== Chain switch / add ====
    function chainHex(id){ return '0x' + Number(id).toString(16) }
    async function ensureTargetChain() {
      if (!provider || !signer) throw new Error('Connect wallet first')
      const wantId = Number(targetChainSelect.value)
      const { chainId: currentId } = await provider.getNetwork()
      if (Number(currentId) === wantId) return
      try {
        await provider.send('wallet_switchEthereumChain', [{ chainId: chainHex(wantId) }])
      } catch (e) {
        // If chain not added, try add
        if (e && e.code === 4902) {
          const c = CHAIN_MAP.get(wantId)
          if (!c) throw new Error('Unknown chain details for add')
          await provider.send('wallet_addEthereumChain', [{
            chainId: chainHex(wantId),
            chainName: c.name,
            nativeCurrency: { name: c.currency, symbol: c.currency, decimals: 18 },
            rpcUrls: c.rpcUrls || [],
            blockExplorerUrls: [c.explorerUrl]
          }])
        } else {
          throw e
        }
      }
      network = await provider.getNetwork()
    }

    // ==== Inputs & validation ====
    function parseArgsJSON(input) {
      const s = (input || '').trim(); if (!s) return []
      try { return JSON.parse(s) } catch { throw new Error('Invalid args JSON. Example: ["0xAddr", 2, true]') }
    }
    function isAddress(v){ try { return ethers.isAddress(v) } catch { return false } }

    function getPrepared() {
      const contractAddress = contractAddressInput.value.trim()
      const abiString = contractAbiInput.value.trim()
      const functionName = functionNameInput.value.trim()
      const args = parseArgsJSON(functionArgsInput.value)
      if (!isAddress(contractAddress)) throw new Error('Invalid contract address')
      if (!functionName) throw new Error('Function name is required')
      let abi; try { abi = JSON.parse(abiString) } catch { throw new Error('Invalid ABI JSON') }
      const contract = new ethers.Contract(contractAddress, abi, signer)
      const txOptions = {}
      if (paymentMethodSelect.value === 'native' && payableValueInput.value) {
        txOptions.value = ethers.parseEther(payableValueInput.value)
      }
      if (paymentMethodSelect.value !== 'native' && 'value' in txOptions) delete txOptions.value
      return { contract, functionName, args, txOptions }
    }

    async function withEip1559Overrides(txOptions) {
      const fee = await provider.getFeeData()
      if (fee.maxFeePerGas && fee.maxPriorityFeePerGas) {
        txOptions.maxFeePerGas = fee.maxFeePerGas
        txOptions.maxPriorityFeePerGas = fee.maxPriorityFeePerGas
      }
      return txOptions
    }

    // ==== Actions ====
    async function simulateCall() {
      try {
        await ensureTargetChain()
        const { contract, functionName, args, txOptions } = getPrepared()
        await withEip1559Overrides(txOptions)
        await contract[functionName].staticCall(...args, txOptions)
        safeLog('Simulation successful: call would succeed.', 'success')
      } catch (e) { safeLog(e.shortMessage || e.reason || e.message || String(e), 'error') }
    }

    async function estimateGasFee() {
      estimateGasButton.disabled = true
      gasEstimateResult.textContent = 'Estimating...'
      gasEstimateResult.classList.remove('text-red-400')
      try {
        await ensureTargetChain()
        const { contract, functionName, args, txOptions } = getPrepared()
        await withEip1559Overrides(txOptions)
        let total = 0n
        const fee = await provider.getFeeData()
        const maxFee = fee.maxFeePerGas || fee.gasPrice || 0n
        if (paymentMethodSelect.value === 'erc20') {
          const token = tokenAddressInput.value.trim()
          const amount = tokenAmountInput.value.trim()
          const spender = (customSpenderInput.value.trim() || contractAddressInput.value.trim())
          if (!isAddress(token) || !isAddress(spender) || !amount) throw new Error('Invalid ERC20 details for estimation')
          const erc20 = new ethers.Contract(token, ERC20_ABI, signer)
          const decimals = await erc20.decimals()
          const want = ethers.parseUnits(amount, decimals)
          const current = await erc20.allowance(userAddress, spender)
          if (current < want) {
            const approveGas = await erc20.approve.estimateGas(spender, want)
            total += approveGas * maxFee
          }
        }
        const gas = await contract[functionName].estimateGas(...args, txOptions)
        total += gas * (fee.maxFeePerGas || fee.gasPrice || 0n)
        gasEstimateResult.textContent = `~${ethers.formatEther(total)} ETH`
        safeLog(`Gas estimation OK. Total estimated: ~${ethers.formatEther(total)} ETH`, 'success')
      } catch (e) {
        gasEstimateResult.textContent = 'Estimation Failed'
        gasEstimateResult.classList.add('text-red-400')
        safeLog(e.shortMessage || e.reason || e.message || String(e), 'error')
      } finally { estimateGasButton.disabled = false }
    }

    async function handleSendTransaction() {
      sendTxButton.disabled = true
      sendTxButton.textContent = 'Processing...'
      try {
        await ensureTargetChain()
        if (paymentMethodSelect.value === 'native') {
          await sendNativeTransaction()
        } else {
          await sendErc20Transaction()
        }
      } finally { sendTxButton.disabled = false; sendTxButton.textContent = 'Send Transaction' }
    }

    async function sendNativeTransaction() {
      safeLog('Preparing native coin transaction...')
      const { contract, functionName, args, txOptions } = getPrepared()
      await withEip1559Overrides(txOptions)
      try {
        await contract[functionName].staticCall(...args, txOptions)
        const gas = await contract[functionName].estimateGas(...args, txOptions)
        txOptions.gasLimit = (gas * 110n) / 100n
        const tx = await contract[functionName](...args, txOptions)
        logLink(`Tx sent: ${tx.hash}`, ex.tx(explorer(network), tx.hash))
        const rcpt = await tx.wait()
        safeLog(`Confirmed in block ${rcpt.blockNumber}`, 'success')
      } catch (err) { safeLog(err.shortMessage || err.reason || err.message || String(err), 'error') }
    }

    async function sendErc20Transaction() {
      safeLog('Preparing ERC20 approval + call...')
      const tokenAddr = tokenAddressInput.value.trim()
      const tokenAmt = tokenAmountInput.value.trim()
      const spenderAddr = (customSpenderInput.value.trim() || contractAddressInput.value.trim())
      if (!isAddress(tokenAddr) || !isAddress(spenderAddr) || !tokenAmt) return safeLog('Invalid Token Address, Spender, or Amount.', 'error')

      const erc20 = new ethers.Contract(tokenAddr, ERC20_ABI, signer)
      try {
        const decimals = await erc20.decimals()
        const want = ethers.parseUnits(tokenAmt, decimals)
        const current = await erc20.allowance(userAddress, spenderAddr)
        if (current < want) {
          safeLog(`Allowance insufficient. Approving ${tokenAmt}...`)
          const fee = await provider.getFeeData()
          const overrides = {}
          if (fee.maxFeePerGas && fee.maxPriorityFeePerGas) {
            overrides.maxFeePerGas = fee.maxFeePerGas
            overrides.maxPriorityFeePerGas = fee.maxPriorityFeePerGas
          }
          const gas = await erc20.approve.estimateGas(spenderAddr, want)
          overrides.gasLimit = (gas * 110n) / 100n
          const aTx = await erc20.approve(spenderAddr, want, overrides)
          logLink(`Approve tx: ${aTx.hash}`, ex.tx(explorer(network), aTx.hash))
          await aTx.wait()
          safeLog('Approval confirmed!', 'success')
        } else { safeLog('Sufficient allowance already exists.') }

        const { contract, functionName, args, txOptions } = getPrepared()
        await withEip1559Overrides(txOptions)
        await contract[functionName].staticCall(...args, txOptions)
        const gas = await contract[functionName].estimateGas(...args, txOptions)
        txOptions.gasLimit = (gas * 110n) / 100n
        const mTx = await contract[functionName](...args, txOptions)
        logLink(`Call tx: ${mTx.hash}`, ex.tx(explorer(network), mTx.hash))
        await mTx.wait()
        safeLog('Transaction confirmed!', 'success')
      } catch (err) { safeLog(err.shortMessage || err.reason || err.message || String(err), 'error') }
    }

    // ==== UI events ====
    connectButton.addEventListener('click', async () => { try { await connectInjected() } catch {} })
    disconnectButton.addEventListener('click', () => disconnectWallet())
    estimateGasButton.addEventListener('click', estimateGasFee)
    simulateButton.addEventListener('click', simulateCall)
    paymentMethodSelect.addEventListener('change', () => {
      const isNative = paymentMethodSelect.value === 'native'
      nativePaymentFields.classList.toggle('hidden', !isNative)
      erc20PaymentFields.classList.toggle('hidden', isNative)
    })
    clearLogsBtn.addEventListener('click', () => (logArea.innerHTML = ''))

    // ==== Populate chain select & restore ====
    function initTargetChainOptions() {
      for (const c of CHAINS) {
        const opt = document.createElement('option')
        opt.value = String(c.chainId)
        opt.textContent = `${c.name} (id: ${c.chainId})`
        targetChainSelect.appendChild(opt)
      }
      const saved = localStorage.getItem('dci.injected.targetChain')
      if (saved && CHAINS.find(c => String(c.chainId) === saved)) targetChainSelect.value = saved
      targetChainSelect.addEventListener('change', () => localStorage.setItem('dci.injected.targetChain', String(targetChainSelect.value)))
    }

    // ==== Init ====
    initTargetChainOptions()

    // Global error guards
    window.addEventListener('error', (e) => safeLog(`JS error: ${e.message}`, 'error'))
    window.addEventListener('unhandledrejection', (e) => safeLog(`Promise rejection: ${e.reason?.message || e.reason}`, 'error'))
  </script>
</body>
</html>
