<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Direct Contract Interaction — Web3Onboard + ethers v6</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#0d0c22;--glass:rgba(23,22,49,.7);--border:rgba(255,255,255,.08);--ring:#e91e63}
    body{font-family:'Inter',sans-serif;background:
      radial-gradient(1200px 600px at 80% -10%,rgba(236,72,153,.15),transparent),
      radial-gradient(900px 500px at -10% 20%,rgba(59,130,246,.12),transparent),
      var(--bg)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .status-dot-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
    .card-bg{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.35);transition:border-color .3s ease,box-shadow .3s ease,transform .2s ease}
    .card-bg:hover{border-color:rgba(233,30,99,.65);box-shadow:0 20px 50px rgba(233,30,99,.12);transform:translateY(-1px)}
    .gradient-title{background:linear-gradient(135deg,#f472b6 0%,#c084fc 35%,#60a5fa 70%,#22d3ee 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
  </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center min-h-screen p-4 md:p-8">
  <div class="w-full max-w-2xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight gradient-title">Direct Contract Interaction</h1>
      
    </header>

    <div class="space-y-6">
      <!-- Step 1: Connect -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-white">Step 1: Connect</h2>
          <div class="flex items-center space-x-2">
            <div id="status-dot" class="w-3 h-3 bg-red-500 rounded-full"></div>
            <span id="status-text" class="text-gray-400">Not Connected</span>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="connectBtn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg shadow-pink-500/20">Connect Wallet</button>
          <button id="disconnectBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 disabled:opacity-50" disabled>Disconnect</button>
        </div>
        <div id="wallet-info" class="mt-4 text-sm text-gray-400 hidden">
          <p>Wallet: <span id="wallet-label" class="font-medium text-cyan-300"></span></p>
          <p>Address: <span id="wallet-address" class="font-mono text-cyan-400"></span></p>
          <p>Network: <span id="network-name" class="font-mono text-cyan-400"></span></p>
        </div>
      </div>

      <!-- Step 2: Chain & Contract -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white">Step 2: Chain & Contract</h2>
        <div class="mt-4 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Target Chain</label>
            <select id="targetChain" class="w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500"></select>
            <p class="text-xs text-gray-500 mt-1">We’ll use Web3Onboard’s chain switching under the hood.</p>
          </div>
          <div>
            <label for="contractAddress" class="block text-sm font-medium text-gray-300">Contract Address</label>
            <input id="contractAddress" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0x..." />
          </div>
          <div>
            <label for="contractAbi" class="block text-sm font-medium text-gray-300">Contract ABI (JSON)</label>
            <textarea id="contractAbi" rows="6" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder='[{"type":"function","name":"mint","stateMutability":"payable","inputs":[{"name":"qty","type":"uint256"}],"outputs":[]}]'></textarea>
          </div>
        </div>
      </div>

      <!-- Step 3: Build & Send -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white">Step 3: Build & Send</h2>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-300 mb-2">Payment Method</label>
          <select id="paymentMethod" class="w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500">
            <option value="native">Native Coin (ETH/MATIC/etc.)</option>
            <option value="erc20">ERC20 Token (USDT/USDC/etc.)</option>
          </select>
        </div>

        <div id="nativeFields" class="mt-4 space-y-4">
          <div>
            <label for="payableValue" class="block text-sm font-medium text-gray-300">Value to Send (ETH)</label>
            <input id="payableValue" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0.1" />
          </div>
        </div>

        <div id="erc20Fields" class="hidden mt-4 space-y-4">
          <div>
            <label for="tokenAddress" class="block text-sm font-medium text-gray-300">Token Contract Address</label>
            <input id="tokenAddress" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="0x... (USDT/USDC etc)" />
          </div>
          <div>
            <label for="tokenAmount" class="block text-sm font-medium text-gray-300">Token Amount (human units)</label>
            <input id="tokenAmount" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="e.g., 100" />
          </div>
          <div>
            <label for="customSpender" class="block text-sm font-medium text-gray-300">Custom Spender (optional)</label>
            <input id="customSpender" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="Router/processor if not the mint contract" />
          </div>
        </div>

        <div class="mt-4 space-y-4">
          <div>
            <label for="functionName" class="block text-sm font-medium text-gray-300">Function Name</label>
            <input id="functionName" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="mint, claim, buy" />
          </div>
          <div>
            <div class="flex items-center justify-between">
              <label for="functionArgs" class="block text-sm font-medium text-gray-300">Function Arguments (JSON array)</label>
              <span class="text-xs text-gray-400">Example: ["0xAbC...", 2, true, [1,2,3]]</span>
            </div>
            <input id="functionArgs" type="text" class="mt-1 block w-full bg-gray-900/50 border border-gray-700 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="[] if none" />
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
          <div id="gasResult" class="text-sm text-gray-400">Fill details to estimate gas...</div>
          <button id="estimateBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-300 shadow-lg shadow-cyan-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Estimate Gas</button>
        </div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button id="sendBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg shadow-green-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Send Transaction</button>
          <button id="simulateBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg shadow-amber-500/20 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Simulate (static call)</button>
        </div>
      </div>

      <!-- Logs -->
      <div class="card-bg p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-white">Logs & Status</h2>
          <button id="clearLogs" class="text-xs text-gray-400 hover:text-gray-200 underline">Clear</button>
        </div>
        <div id="logArea" class="mt-4 bg-gray-900/50 rounded-md p-4 h-60 overflow-y-auto font-mono text-sm text-gray-400"><p>Awaiting connection...</p></div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-8 mb-4">
    <p class="text-sm text-gray-500">Made by <a href="https://x.com/0xKangLiu" target="_blank" rel="noopener noreferrer" class="text-pink-400 hover:underline">Alan</a></p>
  </footer>

  <script type="module">
    import Onboard from 'https://esm.sh/@web3-onboard/core@2?bundle'
    import injectedModule from 'https://esm.sh/@web3-onboard/injected-wallets@2?bundle'
    import walletConnectModule from 'https://esm.sh/@web3-onboard/walletconnect@2?bundle'
    import { ethers } from 'https://esm.sh/ethers@6.11.1'

    // ===== Chains (Onboard format) =====
    const CHAINS = [
      { id: '0x1',    token: 'ETH',  label: 'Ethereum',       rpcUrl: 'https://cloudflare-eth.com' },
      { id: '0xa',    token: 'ETH',  label: 'OP Mainnet',     rpcUrl: 'https://mainnet.optimism.io' },
      { id: '0x2105', token: 'ETH',  label: 'Base',           rpcUrl: 'https://mainnet.base.org' },
      { id: '0xa4b1', token: 'ETH',  label: 'Arbitrum One',   rpcUrl: 'https://arb1.arbitrum.io/rpc' },
      { id: '0x5a2',  token: 'ETH',  label: 'Zora',           rpcUrl: 'https://rpc.zora.energy' },
      { id: '0xe708', token: 'ETH',  label: 'Linea',          rpcUrl: 'https://rpc.linea.build' },
      { id: '0x144',  token: 'ETH',  label: 'zkSync Era',     rpcUrl: 'https://mainnet.era.zksync.io' },
      { id: '0x38',   token: 'BNB',  label: 'BNB Chain',      rpcUrl: 'https://bsc-dataseed.binance.org' },
      { id: '0x89',   token: 'MATIC',label: 'Polygon',        rpcUrl: 'https://polygon-rpc.com' },
      { id: '0xa86a', token: 'AVAX', label: 'Avalanche C',    rpcUrl: 'https://api.avax.network/ext/bc/C/rpc' },
      { id: '0xfa',   token: 'FTM',  label: 'Fantom',         rpcUrl: 'https://rpc.ftm.tools' },
      { id: '0x19',   token: 'CRO',  label: 'Cronos',         rpcUrl: 'https://evm.cronos.org' },
      { id: '0x64',   token: 'xDAI', label: 'Gnosis',         rpcUrl: 'https://rpc.gnosischain.com' },
      { id: '0x504',  token: 'GLMR', label: 'Moonbeam',       rpcUrl: 'https://rpc.api.moonbeam.network' },
      { id: '0x505',  token: 'MOVR', label: 'Moonriver',      rpcUrl: 'https://rpc.api.moonriver.moonbeam.network' },
      // Testnets
      { id: '0xaa36a7', token: 'ETH', label: 'Sepolia',      rpcUrl: 'https://rpc.sepolia.org' },
      { id: '0x14a34',  token: 'ETH', label: 'Base Sepolia', rpcUrl: 'https://sepolia.base.org' },
      { id: '0x66eee',  token: 'ETH', label: 'Arbitrum Sepolia', rpcUrl: 'https://sepolia-rollup.arbitrum.io/rpc' },
      { id: '0xaa37dc', token: 'ETH', label: 'OP Sepolia',   rpcUrl: 'https://sepolia.optimism.io' }
    ]

    // ===== DOM =====
    const connectBtn = document.getElementById('connectBtn')
    const disconnectBtn = document.getElementById('disconnectBtn')
    const statusDot = document.getElementById('status-dot')
    const statusText = document.getElementById('status-text')
    const walletInfo = document.getElementById('wallet-info')
    const walletLabelSpan = document.getElementById('wallet-label')
    const walletAddrSpan = document.getElementById('wallet-address')
    const networkNameSpan = document.getElementById('network-name')

    const contractAddressInput = document.getElementById('contractAddress')
    const contractAbiInput = document.getElementById('contractAbi')
    const functionNameInput = document.getElementById('functionName')
    const functionArgsInput = document.getElementById('functionArgs')

    const paymentMethod = document.getElementById('paymentMethod')
    const nativeFields = document.getElementById('nativeFields')
    const erc20Fields = document.getElementById('erc20Fields')
    const payableValueInput = document.getElementById('payableValue')
    const tokenAddressInput = document.getElementById('tokenAddress')
    const tokenAmountInput = document.getElementById('tokenAmount')
    const customSpenderInput = document.getElementById('customSpender')

    const targetChainSelect = document.getElementById('targetChain')

    const estimateBtn = document.getElementById('estimateBtn')
    const simulateBtn = document.getElementById('simulateBtn')
    const sendBtn = document.getElementById('sendBtn')
    const gasResult = document.getElementById('gasResult')
    const logArea = document.getElementById('logArea')
    const clearLogs = document.getElementById('clearLogs')

    // ===== State =====
    let onboard
    let ethersProvider // ethers.BrowserProvider
    let signer
    let activeWallet // Onboard wallet object

    // ===== Logging =====
    function safeLog(msg, type='info'){
      const now = new Date().toLocaleTimeString()
      const color = type==='error'?'text-red-400':type==='success'?'text-green-400':'text-gray-400'
      const p=document.createElement('p');
      p.innerHTML = `<span class="text-gray-500">${now}:</span> <span class="${color}">${escapeHtml(String(msg))}</span>`
      logArea.appendChild(p); logArea.scrollTop = logArea.scrollHeight
      while(logArea.childNodes.length>500) logArea.removeChild(logArea.firstChild)
    }
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function logLink(label, href){ const p=document.createElement('p'); p.innerHTML=`<span class="text-gray-500">${new Date().toLocaleTimeString()}:</span> <a class="text-pink-400 hover:underline" target="_blank" rel="noopener noreferrer" href="${href}">${escapeHtml(label)}</a>`; logArea.appendChild(p); logArea.scrollTop=logArea.scrollHeight }

    // ===== UI helpers =====
    function setConnected(connected){
      statusDot.classList.toggle('bg-green-500', connected)
      statusDot.classList.toggle('bg-red-500', !connected)
      statusDot.classList.toggle('status-dot-pulse', connected)
      statusText.textContent = connected ? 'Connected' : 'Not Connected'
      walletInfo.classList.toggle('hidden', !connected)
      disconnectBtn.disabled = !connected
      estimateBtn.disabled = !connected
      simulateBtn.disabled = !connected
      sendBtn.disabled = !connected
    }
    function fillChains(){
      for(const c of CHAINS){
        const opt=document.createElement('option')
        opt.value=c.id; opt.textContent=`${c.label} (${parseInt(c.id,16)})`
        targetChainSelect.appendChild(opt)
      }
    }

    // ===== Onboard init =====
    async function initOnboard(){
      // Wallets
      const injected = injectedModule()
      // Optional WalletConnect (set your WC projectId below to enable)
      const wcProjectId = '' // ← put your WalletConnect Project ID here to enable QR wallets
      const wallets = wcProjectId ? [injected, walletConnectModule({ bridge: '', projectId: wcProjectId })] : [injected]

      onboard = Onboard({
        wallets,
        chains: CHAINS,
        appMetadata: {
          name: 'Direct Contract Interaction',
          description: 'Claim/mint reliably via contracts',
          icon: '<svg></svg>',
          recommendedInjectedWallets: [ { name: 'MetaMask', url: 'https://metamask.io' } ]
        },
        accountCenter: { desktop: { enabled: true }, mobile: { enabled: true } }
      })

      // Restore previously connected wallet
      const previouslySelected = JSON.parse(localStorage.getItem('w3o.selected')||'[]')
      if(previouslySelected.length){
        await onboard.connectWallet({ autoSelect: { label: previouslySelected[0], disableModals: true } })
      }

      // Subscribe to state
      onboard.state.select('wallets').subscribe(wallets => {
        if(!wallets || wallets.length===0){
          setConnected(false); activeWallet = null; ethersProvider = null; signer = null
          return
        }
        activeWallet = wallets[0]
        const { accounts, chains, label, provider } = activeWallet
        localStorage.setItem('w3o.selected', JSON.stringify([label]))
        ethersProvider = new ethers.BrowserProvider(provider, 'any')
        signer = new ethers.JsonRpcSigner(ethersProvider, accounts[0].address)
        walletLabelSpan.textContent = label
        walletAddrSpan.textContent = `${accounts[0].address.slice(0,6)}...${accounts[0].address.slice(-4)}`
        networkNameSpan.textContent = CHAINS.find(c=>c.id===chains[0].id)?.label || chains[0].id
        setConnected(true)
        safeLog(`Connected: ${label} on ${networkNameSpan.textContent}`, 'success')
      })
    }

    // ===== Chain switching (Onboard handles it) =====
    async function ensureTargetChain(){
      if(!activeWallet) throw new Error('Connect a wallet first')
      const wantId = targetChainSelect.value
      const curId = activeWallet.chains?.[0]?.id
      if(curId === wantId) return
      const res = await onboard.setChain({ chainId: wantId, wallet: activeWallet.label })
      if(!res || res === null || (res && res.error)){
        throw new Error(res?.error?.message || 'Failed to switch chain')
      }
      networkNameSpan.textContent = CHAINS.find(c=>c.id===wantId)?.label || wantId
      safeLog(`Switched to ${networkNameSpan.textContent}`, 'success')
    }

    // ===== Inputs & ABI =====
    function isAddress(v){ try { return ethers.isAddress(v) } catch { return false } }
    function parseArgsJSON(s){ const t=(s||'').trim(); if(!t) return []; try { return JSON.parse(t) } catch { throw new Error('Invalid args JSON. Example: ["0xAddr", 2, true]') } }

    function getPrepared(){
      const addr = contractAddressInput.value.trim()
      if(!isAddress(addr)) throw new Error('Invalid contract address')
      let abi; try { abi = JSON.parse(contractAbiInput.value.trim()) } catch { throw new Error('Invalid ABI JSON') }
      const fn = functionNameInput.value.trim(); if(!fn) throw new Error('Function name required')
      const args = parseArgsJSON(functionArgsInput.value)
      const contract = new ethers.Contract(addr, abi, signer)
      const tx = {}
      if(paymentMethod.value==='native' && payableValueInput.value){ tx.value = ethers.parseEther(payableValueInput.value) }
      if(paymentMethod.value!=='native' && 'value' in tx) delete tx.value
      return { contract, fn, args, tx }
    }

    // ===== ERC20 helpers =====
    const ERC20_ABI = [
      'function approve(address spender, uint256 amount) returns (bool)',
      'function allowance(address owner, address spender) view returns (uint256)',
      'function decimals() view returns (uint8)'
    ]

    async function withEip1559(tx){
      const fee = await ethersProvider.getFeeData()
      if (fee.maxFeePerGas && fee.maxPriorityFeePerGas){
        tx.maxFeePerGas = fee.maxFeePerGas
        tx.maxPriorityFeePerGas = fee.maxPriorityFeePerGas
      }
      return tx
    }

    // ===== Actions =====
    async function simulate(){
      try{
        await ensureTargetChain()
        const { contract, fn, args, tx } = getPrepared()
        await withEip1559(tx)
        await contract[fn].staticCall(...args, tx)
        safeLog('Simulation successful: call would succeed.', 'success')
      }catch(e){ safeLog(e.shortMessage || e.reason || e.message || String(e), 'error') }
    }

    async function estimate(){
      estimateBtn.disabled = true; gasResult.textContent = 'Estimating...'; gasResult.classList.remove('text-red-400')
      try{
        await ensureTargetChain()
        const { contract, fn, args, tx } = getPrepared()
        await withEip1559(tx)
        let total = 0n
        const fee = await ethersProvider.getFeeData()
        const price = fee.maxFeePerGas || fee.gasPrice || 0n
        if(paymentMethod.value==='erc20'){
          const token = tokenAddressInput.value.trim()
          const amount = tokenAmountInput.value.trim()
          const spender = (customSpenderInput.value.trim() || contractAddressInput.value.trim())
          if(!isAddress(token) || !isAddress(spender) || !amount) throw new Error('Invalid ERC20 details for estimation')
          const erc20 = new ethers.Contract(token, ERC20_ABI, signer)
          const decimals = await erc20.decimals()
          const want = ethers.parseUnits(amount, decimals)
          const allowance = await erc20.allowance(await signer.getAddress(), spender)
          if(allowance < want){
            const g = await erc20.approve.estimateGas(spender, want)
            total += g * price
          }
        }
        const gMain = await contract[fn].estimateGas(...args, tx)
        total += gMain * price
        gasResult.textContent = `~${ethers.formatEther(total)} ETH`
        safeLog(`Gas estimate ≈ ${ethers.formatEther(total)} ETH`, 'success')
      }catch(e){ gasResult.textContent='Estimation Failed'; gasResult.classList.add('text-red-400'); safeLog(e.shortMessage || e.reason || e.message || String(e), 'error') }
      finally{ estimateBtn.disabled = false }
    }

    async function send(){
      sendBtn.disabled = true; sendBtn.textContent='Processing...'
      try{
        await ensureTargetChain()
        if(paymentMethod.value==='native'){
          await sendNative()
        }else{
          await sendERC20()
        }
      }finally{ sendBtn.disabled=false; sendBtn.textContent='Send Transaction' }
    }

    async function sendNative(){
      const { contract, fn, args, tx } = getPrepared(); await withEip1559(tx)
      try{
        await contract[fn].staticCall(...args, tx)
        const g = await contract[fn].estimateGas(...args, tx); tx.gasLimit = (g*110n)/100n
        const res = await contract[fn](...args, tx)
        logLink(`Tx sent: ${res.hash}`, `https://etherscan.io/tx/${res.hash}`)
        const rcpt = await res.wait(); safeLog(`Confirmed in block ${rcpt.blockNumber}`, 'success')
      }catch(e){ safeLog(e.shortMessage || e.reason || e.message || String(e), 'error') }
    }

    async function sendERC20(){
      const token = tokenAddressInput.value.trim(); const amount = tokenAmountInput.value.trim()
      const spender = (customSpenderInput.value.trim() || contractAddressInput.value.trim())
      if(!isAddress(token) || !isAddress(spender) || !amount) return safeLog('Invalid Token Address, Spender, or Amount.', 'error')
      const erc20 = new ethers.Contract(token, ERC20_ABI, signer)
      try{
        const decimals = await erc20.decimals()
        const want = ethers.parseUnits(amount, decimals)
        const allowance = await erc20.allowance(await signer.getAddress(), spender)
        if(allowance < want){
          safeLog(`Approving ${amount}...`)
          const fee = await ethersProvider.getFeeData(); const ov={}
          if(fee.maxFeePerGas && fee.maxPriorityFeePerGas){ ov.maxFeePerGas=fee.maxFeePerGas; ov.maxPriorityFeePerGas=fee.maxPriorityFeePerGas }
          const g = await erc20.approve.estimateGas(spender, want); ov.gasLimit=(g*110n)/100n
          const aTx = await erc20.approve(spender, want, ov); logLink(`Approve tx: ${aTx.hash}`, `https://etherscan.io/tx/${aTx.hash}`); await aTx.wait(); safeLog('Approval confirmed!', 'success')
        }else{ safeLog('Sufficient allowance already exists.') }
        const { contract, fn, args, tx } = getPrepared(); await withEip1559(tx)
        await contract[fn].staticCall(...args, tx)
        const g2 = await contract[fn].estimateGas(...args, tx); tx.gasLimit=(g2*110n)/100n
        const res = await contract[fn](...args, tx)
        logLink(`Call tx: ${res.hash}`, `https://etherscan.io/tx/${res.hash}`)
        await res.wait(); safeLog('Transaction confirmed!', 'success')
      }catch(e){ safeLog(e.shortMessage || e.reason || e.message || String(e), 'error') }
    }

    // ===== Events =====
    connectBtn.addEventListener('click', async () => {
      try{
        await onboard.connectWallet()
      }catch(e){ safeLog(e.message || String(e), 'error') }
    })
    disconnectBtn.addEventListener('click', async () => {
      try{
        const [w] = onboard.state.get().wallets
        if(w) await onboard.disconnectWallet({ label: w.label })
      }catch(e){ safeLog(e.message || String(e), 'error') }
    })

    paymentMethod.addEventListener('change', () => {
      const isNative = paymentMethod.value==='native'
      nativeFields.classList.toggle('hidden', !isNative)
      erc20Fields.classList.toggle('hidden', isNative)
    })
    simulateBtn.addEventListener('click', simulate)
    estimateBtn.addEventListener('click', estimate)
    sendBtn.addEventListener('click', send)
    clearLogs.addEventListener('click', ()=> logArea.innerHTML='')

    // ===== Init =====
    fillChains()
    initOnboard()

    window.addEventListener('error', e=> safeLog(`JS error: ${e.message}`, 'error'))
    window.addEventListener('unhandledrejection', e=> safeLog(`Promise rejection: ${e.reason?.message || e.reason}`, 'error'))
  </script>
</body>
</html>
